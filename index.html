<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שאלון שימור ידע - קוראל</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8a;
            --accent: #e8b931;
            --success: #2d8a5f;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #1a1a2e;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 24px rgba(30, 58, 95, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.7;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            padding: 24px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--primary);
        }

        .header p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Progress */
        .progress-container {
            margin-bottom: 24px;
        }

        .progress-topics {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .topic-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            background: var(--border);
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .topic-badge.active {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .topic-badge.completed {
            background: var(--success);
            color: white;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Question Card */
        .question-card {
            background: var(--card);
            border-radius: 16px;
            padding: 28px;
            box-shadow: var(--shadow);
        }

        .topic-title {
            display: inline-block;
            background: var(--primary-light);
            color: white;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .question-number {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .question-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        /* Scaffolding - the key improvement */
        .question-scaffold {
            background: linear-gradient(135deg, #f0f7ff 0%, #e8f4f8 100%);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            border-right: 4px solid var(--primary-light);
        }

        .scaffold-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .scaffold-points {
            list-style: none;
            padding: 0;
        }

        .scaffold-points li {
            padding: 6px 0;
            padding-right: 24px;
            position: relative;
            font-size: 0.9rem;
            color: var(--text);
        }

        .scaffold-points li::before {
            content: "→";
            position: absolute;
            right: 0;
            color: var(--primary-light);
            font-weight: bold;
        }

        .scaffold-example {
            background: white;
            border-radius: 8px;
            padding: 14px;
            margin-top: 12px;
            font-size: 0.85rem;
            border: 1px dashed var(--border);
        }

        .scaffold-example-label {
            font-weight: 600;
            color: var(--success);
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .scaffold-example-text {
            color: var(--text-light);
            font-style: italic;
        }

        /* Answer Area */
        textarea {
            width: 100%;
            min-height: 140px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s ease;
            line-height: 1.6;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea::placeholder {
            color: #9ca3af;
        }

        .char-count {
            text-align: left;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 6px;
        }

        /* AI Feedback */
        .ai-feedback {
            margin-top: 16px;
            padding: 16px;
            border-radius: 12px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-feedback.show {
            display: block;
        }

        .ai-feedback.success {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-right: 4px solid var(--success);
        }

        .ai-feedback.warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-right: 4px solid var(--warning);
        }

        .ai-feedback.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-right: 4px solid var(--error);
        }

        .ai-feedback-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .ai-feedback-icon {
            font-size: 1.2rem;
        }

        .ai-feedback-text {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .ai-followup {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-weight: 500;
            color: var(--primary);
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 24px;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text);
        }

        .btn-skip {
            background: transparent;
            color: var(--text-light);
            font-size: 0.9rem;
            padding: 10px 16px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading */
        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 12px;
        }

        .loading-container.active {
            display: flex;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 30px 20px;
        }

        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .welcome-screen h2 {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: var(--primary);
        }

        .welcome-screen p {
            color: var(--text-light);
            margin-bottom: 10px;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
        }

        .welcome-features {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 28px 0;
            text-align: right;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .welcome-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg);
            border-radius: 10px;
        }

        .welcome-feature-icon {
            font-size: 1.5rem;
        }

        .welcome-feature-text {
            font-size: 0.9rem;
        }

        .topics-preview {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 24px 0;
        }

        .topics-preview span {
            background: white;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            border: 1px solid var(--border);
        }

        .btn-start {
            padding: 16px 48px;
            font-size: 1.1rem;
            margin-top: 16px;
        }

        /* Complete Screen */
        .complete-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .complete-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .complete-screen h2 {
            font-size: 1.75rem;
            margin-bottom: 12px;
            color: var(--success);
        }

        .complete-screen p {
            color: var(--text-light);
            margin-bottom: 24px;
        }

        .summary-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 320px;
            margin: 0 auto;
        }

        .btn-export {
            background: var(--success);
            color: white;
        }

        .btn-export:hover {
            background: #238b4d;
        }

        /* Skip Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 100;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 28px;
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .skip-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .skip-option {
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: right;
        }

        .skip-option:hover {
            border-color: var(--primary);
            background: var(--bg);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container { padding: 14px; }
            .question-card { padding: 20px; }
            .question-text { font-size: 1.1rem; }
            .scaffold-points li { font-size: 0.85rem; }
            .button-group { flex-direction: column; }
            .topic-badge { padding: 5px 10px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>📋 שאלון שימור ידע</h1>
            <p>קוראל שירותי ים - מחלקת אדמיניסטרציה</p>
        </header>

        <div id="app">
            <!-- Welcome Screen -->
            <div id="welcome" class="question-card welcome-screen">
                <div class="welcome-icon">👋</div>
                <h2>היי נטלי!</h2>
                <p>השאלון הזה יעזור לנו להשלים את התיעוד של תהליכי העבודה שלך.</p>
                <p><strong>ראינו שכבר מילאת חלק מהנושאים - יופי!</strong> עכשיו נשלים את מה שחסר.</p>
                
                <div class="welcome-features">
                    <div class="welcome-feature">
                        <span class="welcome-feature-icon">🤖</span>
                        <span class="welcome-feature-text">בכל שאלה יש דוגמאות והסברים שיעזרו לך</span>
                    </div>
                    <div class="welcome-feature">
                        <span class="welcome-feature-icon">💬</span>
                        <span class="welcome-feature-text">המערכת תשאל שאלות המשך כדי להשלים פרטים</span>
                    </div>
                    <div class="welcome-feature">
                        <span class="welcome-feature-icon">💾</span>
                        <span class="welcome-feature-text">אפשר לעצור ולהמשיך מאוחר יותר</span>
                    </div>
                </div>

                <p style="color: var(--primary); font-weight: 500;">נושאים להשלמה:</p>
                <div class="topics-preview">
                    <span>🔥 מערכת כיבוי אש</span>
                    <span>🚨 מערכת אזעקה</span>
                    <span>🦺 הדרכת בטיחות</span>
                    <span>🚗 ניהול תיקי רכב</span>
                </div>

                <p><strong>משך זמן משוער:</strong> 15-20 דקות</p>

                <button class="btn btn-primary btn-start" onclick="startQuestionnaire()">בואי נתחיל! 🚀</button>
            </div>

            <!-- Question Screen -->
            <div id="questionnaire" style="display: none;">
                <div class="progress-container">
                    <div class="progress-topics" id="topicBadges"></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">שאלה 1 מתוך 20</div>
                </div>

                <div class="question-card">
                    <span class="topic-title" id="topicTitle">מערכת כיבוי אש</span>
                    <div class="question-number" id="questionNumber">שאלה 1 מתוך 5</div>
                    
                    <h2 class="question-text" id="questionText"></h2>
                    
                    <div class="question-scaffold" id="questionScaffold">
                        <div class="scaffold-title">💡 מה כדאי לכלול בתשובה:</div>
                        <ul class="scaffold-points" id="scaffoldPoints"></ul>
                        <div class="scaffold-example" id="scaffoldExample">
                            <div class="scaffold-example-label">✨ דוגמה לתשובה טובה:</div>
                            <div class="scaffold-example-text" id="exampleText"></div>
                        </div>
                    </div>

                    <textarea 
                        id="answerInput" 
                        placeholder="כתבי את התשובה שלך כאן... נסי לכלול כמה שיותר פרטים"
                        oninput="updateCharCount()"
                    ></textarea>
                    <div class="char-count"><span id="charCount">0</span> תווים</div>

                    <div class="ai-feedback" id="aiFeedback">
                        <div class="ai-feedback-header">
                            <span class="ai-feedback-icon" id="feedbackIcon">💬</span>
                            <span id="feedbackTitle">משוב</span>
                        </div>
                        <div class="ai-feedback-text" id="feedbackText"></div>
                        <div class="ai-followup" id="followupQuestion" style="display: none;"></div>
                    </div>

                    <div class="loading-container" id="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">קוראת את התשובה ובודקת אם צריך להשלים משהו...</div>
                    </div>

                    <div class="button-group" id="buttonGroup">
                        <button class="btn btn-primary" id="submitBtn" onclick="submitAnswer()">שלחי תשובה →</button>
                        <button class="btn btn-skip" onclick="showSkipModal()">לא עוסקת בזה ❌</button>
                    </div>

                    <div class="button-group" id="continueGroup" style="display: none;">
                        <button class="btn btn-primary" onclick="continueToNext()">המשיכי לשאלה הבאה →</button>
                        <button class="btn btn-secondary" onclick="addMoreDetails()">רוצה להוסיף עוד פרטים</button>
                    </div>
                </div>
            </div>

            <!-- Complete Screen -->
            <div id="complete" class="question-card complete-screen" style="display: none;">
                <div class="complete-icon">🎉</div>
                <h2>כל הכבוד! סיימת!</h2>
                <p>כל התשובות נשמרו. עכשיו אפשר להוריד את הקובץ המלא.</p>

                <div class="summary-stats">
                    <div class="stat">
                        <div class="stat-number" id="totalAnswers">0</div>
                        <div class="stat-label">תשובות חדשות</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">4</div>
                        <div class="stat-label">נושאים הושלמו</div>
                    </div>
                </div>

                <div class="export-buttons">
                    <button class="btn btn-primary btn-export" onclick="exportToWord()">📄 הורדת קובץ Word</button>
                    <button class="btn btn-secondary" onclick="previewContent()">👁️ צפייה מקדימה</button>
                </div>
            </div>
        </div>

        <!-- Skip Modal -->
        <div class="modal-overlay" id="skipModal">
            <div class="modal-content">
                <h3>למה את לא עוסקת בנושא הזה?</h3>
                <div class="skip-options">
                    <div class="skip-option" onclick="skipQuestion('לא באחריות שלי - מישהו אחר מטפל')">👤 לא באחריות שלי - מישהו אחר מטפל</div>
                    <div class="skip-option" onclick="skipQuestion('לא קיים במשרד שלנו')">🏢 לא קיים במשרד שלנו</div>
                    <div class="skip-option" onclick="skipQuestion('לא יודעת מספיק על הנושא')">❓ לא יודעת מספיק על הנושא</div>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 16px;" onclick="closeSkipModal()">ביטול</button>
            </div>
        </div>

        <!-- Preview Modal -->
        <div class="modal-overlay" id="previewModal">
            <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h3>תצוגה מקדימה</h3>
                <div id="previewContent" style="text-align: right; font-size: 0.9rem;"></div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 16px;" onclick="closePreviewModal()">סגור</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.2.3/docx.min.js"></script>

    <script>
        // ============ EXISTING CONTENT FROM NATALI'S DOCUMENT ============
        const EXISTING_CONTENT = {
            "רכש ציוד משרדי": {
                process: `1. אחת לחודש, או לפי צורך, נבדק מלאי ציוד משרדי (נייר, טונרים, כלי כתיבה וכו').
2. במידה ויש חוסרים - נערכת רשימת הזמנות בקובץ "ציוד משרדי".
3. נשלחות בקשות להצעות מחיר מספקים קבועים (אופיס דיפו / קלמר).
4. לאחר קבלת הצעות ואישור תקציב ממנהל/ת הרכש או האדמיניסטרציה, מבוצעת ההזמנה.
5. עם קבלת ההזמנה - נבדקת התאמה להזמנה, נרשמת קבלה במלאי, וחשבונית מועברת להנהלת חשבונות לתשלום.`
            },
            "הזמנת אוכל מהסופר": {
                process: `1. אחת לשבוע נבדק מלאי המטבח (חלב, קפה, סוכר, כיבוד, כלים חד פעמיים וכו').
2. נערכת רשימת הזמנה מסודרת על פי הצרכים.
3. מבוצעת הזמנה אונליין מאתרים כמו שופרסל אונליין.
4. מתואם מועד אספקה.
5. עם הגעת ההזמנה - נבדקת התאמה לחשבונית והסחורה נפרקת למטבח.
6. חשבונית מועברת להנה"ח לתשלום.`
            },
            "הזמנת אוכל לארוחות צהריים והרמות כוסית": {
                process: `1. תיאום תאריך וסוג האירוע (למשל הרמת כוסית, יום הולדת, מפגש צוות).
2. איסוף העדפות תפריט מהעובדים (רגיל / צמחוני / טבעוני).
3. קבלת הצעות מחיר ממסעדות או חברות קייטרינג קבועות.
4. בחירת ספק וביצוע ההזמנה.
5. קבלת משלוח, בדיקת התאמה להזמנה.
6. תיעוד והעברת החשבונית להנהלת חשבונות.`
            },
            "טיפול בדואר בין-משרדי": {
                process: `1. בכל יום מתקבל דואר נכנס (ממוקד / דואר ישראל).
2. מתבצע מיון לפי מחלקות או עובדים.
3. דואר יוצא מועבר באמצעות דואר ישראל.
4. ניהול מעקב אחר משלוחים עד הגעתם ליעד.`
            },
            "גניזה של חומר": {
                process: `1. אחת לחצי שנה מבוצעת סקירה של קלסרים וחומרי נייר ישנים.
2. נבחנת רמת הרלוונטיות של החומר בהתאם למדיניות שמירת מסמכים.
3. חומר שאינו נדרש מועבר לגניזה באמצעות חברת גניזה מוסמכת.
4. עם סיום התהליך מתקבל אישור השמדה הנשמר בתיק הנהלת חשבונות.`
            },
            "מערכת מיזוג אוויר": {
                process: `1. אחת לרבעון, או לפי צורך, מתואם טיפול עם חברת אחזקה קבועה.
2. נבדקים פילטרים, יחידות פנים וחוץ, תרמוסטטים, ותפקוד כללי של המערכת.
3. במידה ויש תקלה, נפתחת קריאת שירות ונעשה מעקב עד לפתרונה.
4. דו"ח טיפול נשמר בתיק אחזקה.`,
                supplier: "אלקטרה"
            },
            "חניה במתחם מת\"ם": {
                process: `1. ניהול רשימת מקומות חניה לעובדים קבועים ולמבקרים.
2. עדכון שמות רכבים ומספרי רישוי במערכת מול מערכת ניהול רכבים מת"ם.
3. הנפקת אישורי חניה זמניים לעובדים חדשים או אורחים.
4. מעקב שוטף אחר זמינות מקומות חניה ופתרון בעיות מול חברת הניהול.
5. שמירת קובץ מעקב חניה מעודכן בתיק לוגיסטיקה.`
            },
            "נסיעות לחו\"ל": {
                process: `1. מתקבלת בקשה לנסיעה לחו"ל ממנהל/ת ישיר/ה או גורם מוסמך.
2. מבוצעות הזמנות עבור הנוסע/ת בהתאם לדרישות:
   - הזמנת טיסות ומלונות דרך סוכן הנסיעות
   - תיאום הסעות לשדה התעופה ובחזרה באמצעות שירות טל לימוזין
   - הזמנת שירותי קיצור תורים בנתב"ג (VIP Fast Track) במידת הצורך
   - טיפול בהנפקת ביטוח נסיעות לחו"ל עבור כל נוסע
   - הזמנת חבילת חו"ל סלולרית דרך ספק התקשורת של החברה
3. ווידוא שכל האישורים, ההזמנות והביטוחים נשלחו לעובד לפני מועד הטיסה.`
            },
            "שליחת דואר ובלדרות לחו\"ל": {
                process: `1. מתקבלת בקשה לשליחת פריטים לחו"ל (למשל דוגמאות שמן, מסמכים מקוריים, שטרי מטען, חוזים וכדומה).
2. נבדקת כתובת היעד, סוג המשלוח ודחיפותו.
3. האריזה מתבצעת בהתאם לסוג הפריט (קופסה קשיחה, עטיפה מרופדת, סימון "שביר" במידת הצורך).
4. מילוי טופס משלוח במערכת DHL Express - כולל פרטי שולח, נמען, תכולה וערך לצורכי מכס.
5. במידת הצורך, יצירת חשבון משלוח על שם החברה.
6. תיאום איסוף של החבילה עם שליח DHL מהכתובת במשרד.
7. קבלת מספר מעקב (Tracking Number) ושמירתו במערכת המעקב הפנימית.
8. מעקב יומי אחר סטטוס המשלוח עד לאישור מסירה אצל הנמען.
9. שמירת תיעוד המשלוח (שטר מטען, חשבונית, אישור מסירה) בתקיית "משלוחים לחו"ל".`,
                suppliers: "DHL Express, FedEx (במקרים חריגים)",
                notes: "חשוב לוודא שהפריטים ארוזים היטב. מומלץ לתאם משלוח בשעות הבוקר להבטחת איסוף באותו יום."
            },
            "בקשות לאישורי כניסה לנמל חיפה": {
                process: `1. מתקבלת בקשה ממחלקת תפעול / ספק חיצוני לביצוע עבודה תפעולית בנמל חיפה.
2. נפתחת בקשה במערכת הייעודית של נמל חיפה - מערכת אישורי כניסה ממוחשבת.
3. מוזנים פרטי המבקר: שם מלא, תעודת זהות, חברה מייצגת, מטרה, תאריכי כניסה נדרשים וסוג רכב (אם נדרש).
4. הבקשה נבדקת ומועברת לאישור מול מוקד נמל חיפה / ביטחון נמל.
5. לאחר קבלת אישור, נשמר עותק דיגיטלי של האישור בתקיית "אישורי כניסה לנמל".
6. האישור נשלח למבקר/חברה לצורך הצגה בשער הכניסה לנמל.
7. במקרה של כניסות חוזרות או קבועות - נדרש לחדש את הבקשה אחת לתקופה בהתאם לנהלי הנמל.`,
                stakeholders: "מוקד נמל חיפה, מחלקת ביטחון נמל, מחלקת תפעול פנימית",
                notes: "חובה להגיש בקשה לפחות יום עבודה מראש. כל מבקר חייב תעודת זהות תקפה ואישור מודפס."
            },
            "כנס שנתי של החברה": {
                process: `לפני הכנס:
1. בנייה וניהול רשימת מוזמנים הכוללת כ-500 איש.
2. שליחת הודעת Save the Date לכלל המוזמנים.
3. שליחת הזמנה רשמית עם פרטי מיקום, שעות ופרטי התקשרות.
4. ניהול מעקב אחר אישורי הגעה (RSVP).
5. ביצוע שיחות טלפוניות למוזמנים לצורך וידוא הגעה.
6. עדכון רשימת משתתפים סופית בהתאם לאישורי ההגעה.
7. הזמנת שרוכים ותגי שם.
8. הדפסת תגי שם למשתתפים שאישרו הגעה, כולל תגי גיבוי.

ביום הכנס:
1. הגעה מוקדמת והקמת עמדת רישום.
2. קבלת פני המשתתפים בכניסה לכנס.
3. רישום המשתתפים בפועל בהתאם לרשימה המעודכנת.
4. חלוקת תגי שם ושרוכים.
5. מתן מענה למשתתפים שאינם מופיעים ברשימה או לשינויים של הרגע האחרון.
6. ניהול שוטף של עמדת הרישום לאורך כל יום הכנס.

אחרי הכנס:
1. שמירת רשימת המשתתפים הסופית לצורכי תיעוד ובקרה.
2. העברת חשבוניות רלוונטיות (הדפסות, שרוכים, ספקים) להנהלת חשבונות.
3. תיעוד הערות / תובנות לשיפור הכנס הבא.`
            }
        };

        // ============ QUESTIONS DATA - RICH SCAFFOLDING ============
        const TOPICS = [
            {
                id: 'fire',
                name: 'מערכת כיבוי אש',
                icon: '🔥',
                questions: [
                    {
                        id: 'fire_overview',
                        text: 'ספרי לנו על מערכת כיבוי האש במשרד - מה יש ומי מטפל?',
                        scaffoldTitle: 'נסי לכלול בתשובה:',
                        scaffoldPoints: [
                            'מה סוג המערכת? (גלאי עשן, ספרינקלרים, מטפים)',
                            'מי הספק / חברת האחזקה?',
                            'יש איש קשר קבוע? (שם, טלפון)',
                            'איפה נמצאים המטפים במשרד?'
                        ],
                        example: 'יש לנו גלאי עשן בכל החדרים ו-4 מטפי כיבוי (2 במסדרון, 1 במטבח, 1 בשרת). חברת "בטיחות פלוס" מטפלת במערכת, איש הקשר שלנו הוא יוסי - 050-1234567.',
                        category: 'סקירה כללית'
                    },
                    {
                        id: 'fire_schedule',
                        text: 'מתי ואיך מתבצעות בדיקות למערכת כיבוי האש?',
                        scaffoldTitle: 'פרטים חשובים:',
                        scaffoldPoints: [
                            'כל כמה זמן יש בדיקה? (חודשי, רבעוני, שנתי)',
                            'מי יוזם את הבדיקה - את או הספק?',
                            'מה בודקים בדיוק?',
                            'האם צריך לתאם מראש?'
                        ],
                        example: 'פעם בשנה חברת הבטיחות מתקשרת לתאם בדיקה. הם בודקים את כל הגלאים, מחליפים סוללות, ובודקים תוקף של המטפים. אני צריכה להיות נוכחת כדי לפתוח את כל החדרים.',
                        category: 'תהליך עבודה'
                    },
                    {
                        id: 'fire_docs',
                        text: 'איזה תיעוד שומרים אחרי בדיקה? איפה?',
                        scaffoldTitle: 'סוגי מסמכים:',
                        scaffoldPoints: [
                            'האם מקבלים אישור/תעודה אחרי בדיקה?',
                            'איפה שומרים את זה? (תיק פיזי, מחשב, שניהם)',
                            'כמה זמן צריך לשמור?',
                            'מי צריך לראות את המסמכים האלה?'
                        ],
                        example: 'אחרי כל בדיקה מקבלים תעודת כשירות. אני שומרת עותק סרוק בתיקייה "בטיחות" בכונן המשותף, ועותק מודפס בקלסר האדום במשרד שלי. צריך לשמור 7 שנים.',
                        category: 'תיעוד'
                    },
                    {
                        id: 'fire_emergency',
                        text: 'מה עושים אם יש תקלה או אזעקת אש?',
                        scaffoldTitle: 'מצבים שיכולים לקרות:',
                        scaffoldPoints: [
                            'גלאי עשן מצפצף בלי סיבה - מה עושים?',
                            'למי מתקשרים במקרה חירום?',
                            'יש נוהל פינוי? מי אחראי?',
                            'מה עושים אחרי אזעקת שווא?'
                        ],
                        example: 'אם גלאי מצפצף - קודם בודקים שאין עשן אמיתי. אם זה שווא - יש לי מספר של הטכנאי יוסי. במקרה של אש אמיתית - מתקשרים ל-102 ומפנים את המשרד דרך חדר המדרגות.',
                        category: 'טיפול בחריגים'
                    }
                ]
            },
            {
                id: 'alarm',
                name: 'מערכת אזעקה',
                icon: '🚨',
                questions: [
                    {
                        id: 'alarm_overview',
                        text: 'ספרי על מערכת האזעקה במשרד - מה יש ומי הספק?',
                        scaffoldTitle: 'פרטים חשובים:',
                        scaffoldPoints: [
                            'איזה סוג מערכת? (חברת מוקד, מצלמות, חיישנים)',
                            'שם חברת האזעקה',
                            'יש מוקד שמקבל התראות?',
                            'איש קשר לשירות'
                        ],
                        example: 'יש לנו מערכת של חברת "השומר החדש" עם חיישני תנועה בכל החדרים ומצלמות בכניסה. המוקד שלהם מקבל התראות 24/7. איש הקשר - דני 03-9876543.',
                        category: 'סקירה כללית'
                    },
                    {
                        id: 'alarm_daily',
                        text: 'איך פותחים וסוגרים את המשרד? מי עושה את זה?',
                        scaffoldTitle: 'שגרה יומית:',
                        scaffoldPoints: [
                            'מי מגיע ראשון בבוקר? מי סוגר בסוף?',
                            'איך מכבים/מדליקים את האזעקה?',
                            'יש קוד? מי יודע אותו?',
                            'מה קורה אם מישהו שוכח לסגור?'
                        ],
                        example: 'בדרך כלל אני או משה מגיעים ראשונים ומכבים את האזעקה עם הקוד. בסוף היום, מי שיוצא אחרון מדליק. יש לנו 3 אנשים עם קוד. אם שוכחים - המוקד מתקשר.',
                        category: 'תהליך עבודה'
                    },
                    {
                        id: 'alarm_codes',
                        text: 'איך מנהלים את הקודים והסיסמאות של האזעקה?',
                        scaffoldTitle: 'ניהול גישה:',
                        scaffoldPoints: [
                            'כמה אנשים יודעים את הקוד?',
                            'מתי מחליפים קוד? (עובד עוזב, פעם בשנה...)',
                            'איך מעדכנים אנשים חדשים?',
                            'איפה שומרים גיבוי של הקוד?'
                        ],
                        example: 'יש 4 אנשים עם קוד - אני, המנכ"ל, מנהל התפעול וראש צוות. כשעובד עוזב - מחליפים קוד תוך שבוע. הקוד שמור בכספת של המנכ"ל למקרה חירום.',
                        category: 'אבטחת מידע'
                    },
                    {
                        id: 'alarm_false',
                        text: 'מה קורה כשיש אזעקת שווא?',
                        scaffoldTitle: 'טיפול באזעקות:',
                        scaffoldPoints: [
                            'מי מקבל טלפון מהמוקד?',
                            'מה השאלות שהם שואלים?',
                            'צריך להגיע למשרד?',
                            'יש קנסות על אזעקות שווא?'
                        ],
                        example: 'המוקד מתקשר אליי או למשה. הם שואלים סיסמה מזהה ואז מבררים מה קרה. אם זה שווא - אומרים להם והכל בסדר. אחרי 3 אזעקות שווא בחודש יש קנס.',
                        category: 'טיפול בחריגים'
                    }
                ]
            },
            {
                id: 'safety',
                name: 'הדרכת בטיחות',
                icon: '🦺',
                questions: [
                    {
                        id: 'safety_overview',
                        text: 'ספרי על הדרכות הבטיחות בחברה - מה עושים ומתי?',
                        scaffoldTitle: 'מידע כללי:',
                        scaffoldPoints: [
                            'כל כמה זמן יש הדרכת בטיחות?',
                            'מי מחליט שצריך הדרכה?',
                            'האם זה חובה לכל העובדים?',
                            'כמה זמן נמשכת הדרכה?'
                        ],
                        example: 'יש הדרכת בטיחות פעם בשנה, בדרך כלל באוקטובר. זה חובה לכל העובדים לפי חוק. ההדרכה נמשכת בערך שעה וחצי.',
                        category: 'סקירה כללית'
                    },
                    {
                        id: 'safety_provider',
                        text: 'מי מעביר את הדרכת הבטיחות ומה לומדים?',
                        scaffoldTitle: 'תוכן ההדרכה:',
                        scaffoldPoints: [
                            'חברה חיצונית או מישהו מבפנים?',
                            'מה הנושאים? (כיבוי אש, מילוט, עזרה ראשונה)',
                            'יש חלק מעשי? (תרגול מטף למשל)',
                            'איפה מתקיימת ההדרכה?'
                        ],
                        example: 'חברת "בטיחות פרו" מעבירה את ההדרכה. לומדים על כיבוי אש, שימוש במטף, דרכי מילוט, ועזרה ראשונה בסיסית. יש תרגול מעשי עם מטף בחצר. זה מתקיים בחדר הישיבות הגדול.',
                        category: 'תהליך עבודה'
                    },
                    {
                        id: 'safety_docs',
                        text: 'איזה תיעוד יש להדרכת הבטיחות?',
                        scaffoldTitle: 'מסמכים ורישום:',
                        scaffoldPoints: [
                            'יש טופס נוכחות? מי חותם?',
                            'מקבלים תעודה או אישור?',
                            'איפה שומרים את המסמכים?',
                            'כמה שנים צריך לשמור?'
                        ],
                        example: 'כל עובד חותם על טופס נוכחות. מקבלים אישור מהחברה שההדרכה בוצעה. אני שומרת את הטפסים בקלסר "הדרכות" ועותק סרוק במחשב. לפי חוק צריך לשמור 7 שנים.',
                        category: 'תיעוד'
                    },
                    {
                        id: 'safety_new',
                        text: 'מה קורה כשמגיע עובד חדש? יש הדרכה מיוחדת?',
                        scaffoldTitle: 'עובדים חדשים:',
                        scaffoldPoints: [
                            'האם עובד חדש מקבל הדרכה מיד?',
                            'מי אחראי להדריך אותו?',
                            'מה מלמדים אותו? (דרכי מילוט, מטפים...)',
                            'יש משהו שהוא חותם עליו?'
                        ],
                        example: 'עובד חדש מקבל סיור בטיחות ביום הראשון - אני מראה לו איפה המטפים, דרכי המילוט ונקודת ההתכנסות. הוא חותם שקיבל הדרכה. אם הוא מתחיל אחרי ההדרכה השנתית, הוא מצטרף בשנה הבאה.',
                        category: 'קליטת עובדים'
                    }
                ]
            },
            {
                id: 'vehicles',
                name: 'ניהול תיקי רכב',
                icon: '🚗',
                questions: [
                    {
                        id: 'vehicles_overview',
                        text: 'ספרי על הרכבים של החברה - כמה יש ומי משתמש?',
                        scaffoldTitle: 'מידע בסיסי:',
                        scaffoldPoints: [
                            'כמה רכבים יש לחברה?',
                            'איזה סוג? (ליסינג, בעלות, שכירות)',
                            'מי משתמש בכל רכב?',
                            'יש רכב משותף או רכב צמוד?'
                        ],
                        example: 'יש לנו 5 רכבים - 3 בליסינג ו-2 בבעלות. 2 רכבים צמודים למנהלים, ו-3 רכבים משותפים לסוכנים בשטח. חברת הליסינג היא "אלדן".',
                        category: 'סקירה כללית'
                    },
                    {
                        id: 'vehicles_insurance',
                        text: 'איך מטפלים בביטוח של הרכבים?',
                        scaffoldTitle: 'נושאי ביטוח:',
                        scaffoldPoints: [
                            'מי סוכן הביטוח?',
                            'מתי מחדשים ביטוח? (כולם ביחד או בתאריכים שונים)',
                            'מי מטפל בחידוש?',
                            'איפה שומרים את הפוליסות?'
                        ],
                        example: 'סוכן הביטוח שלנו הוא יעקב מ"ביטוח ישיר". כל הביטוחים מתחדשים ב-1 בינואר. יעקב שולח לי תזכורת חודש לפני, אני מעבירה למנכ"ל לאישור, ואז הוא מחדש. הפוליסות בתיק "ביטוחים" במשרד שלי.',
                        category: 'תהליך עבודה'
                    },
                    {
                        id: 'vehicles_test',
                        text: 'איך מתנהל נושא הטסט השנתי?',
                        scaffoldTitle: 'טסט שנתי:',
                        scaffoldPoints: [
                            'איך יודעים מתי צריך טסט?',
                            'מי מתאם את הטסט?',
                            'לאיזה מכון לוקחים?',
                            'מה עושים אם הרכב לא עובר?'
                        ],
                        example: 'יש לי אקסל עם תאריכי טסט של כל הרכבים. חודש לפני אני מתאמת עם מכון "ניו טסט" בקריות. הנהג לוקח את הרכב. אם לא עובר - המכון נותן רשימה מה לתקן ומתאמים תאריך חדש.',
                        category: 'תהליך עבודה'
                    },
                    {
                        id: 'vehicles_maintenance',
                        text: 'איך מתנהלת התחזוקה השוטפת של הרכבים?',
                        scaffoldTitle: 'טיפולים ותחזוקה:',
                        scaffoldPoints: [
                            'יש מוסך קבוע?',
                            'איך יודעים שצריך טיפול? (ק"מ, זמן, נורית)',
                            'מי מתאם את הטיפול?',
                            'מי משלם? יש תקציב?'
                        ],
                        example: 'המוסך הקבוע שלנו הוא "אלון רכב" בחיפה. לרכבי הליסינג - אלדן שולחים תזכורת. לרכבים שלנו - הנהגים מדווחים או שאני עוקבת לפי ק"מ. יש תקציב שנתי של 15,000 ש"ח לתחזוקה.',
                        category: 'תחזוקה'
                    },
                    {
                        id: 'vehicles_accident',
                        text: 'מה הנוהל במקרה של תאונה או נזק לרכב?',
                        scaffoldTitle: 'טיפול בתאונות:',
                        scaffoldPoints: [
                            'מה הנהג צריך לעשות מיד?',
                            'למי מדווחים בחברה?',
                            'איך פותחים תביעה בביטוח?',
                            'יש טופס דיווח?'
                        ],
                        example: 'הנהג צריך: 1) לצלם את הנזק ופרטי הצד השני 2) להתקשר אליי מיד 3) למלא טופס תאונה. אני מעבירה לסוכן הביטוח שפותח תביעה. יש טופס במכונית ואצלי במשרד.',
                        category: 'טיפול בחריגים'
                    },
                    {
                        id: 'vehicles_docs',
                        text: 'איפה ואיך שומרים את כל המסמכים של הרכבים?',
                        scaffoldTitle: 'ניהול תיקים:',
                        scaffoldPoints: [
                            'יש תיק לכל רכב?',
                            'מה נמצא בתיק? (רישיון, ביטוח, טסטים, טיפולים)',
                            'תיק פיזי, דיגיטלי, או שניהם?',
                            'מי אחראי לעדכן?'
                        ],
                        example: 'יש תיק נפרד לכל רכב - גם פיזי במגירה וגם תיקייה במחשב. בתיק: צילום רישיון רכב, פוליסת ביטוח, אישורי טסט, וקבלות טיפולים. אני מעדכנת אחרי כל אירוע.',
                        category: 'תיעוד'
                    }
                ]
            }
        ];

        // ============ STATE ============
        let state = {
            currentTopicIndex: 0,
            currentQuestionIndex: 0,
            answers: {},
            skipped: {},
            waitingForFollowup: false,
            currentFollowup: null
        };

        const STORAGE_KEY = 'natali_questionnaire_v2';

        // ============ LOCAL STORAGE ============
        function saveProgress() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function loadProgress() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        function clearProgress() {
            localStorage.removeItem(STORAGE_KEY);
        }

        // ============ INITIALIZATION ============
        function init() {
            const saved = loadProgress();
            if (saved && (Object.keys(saved.answers || {}).length > 0 || Object.keys(saved.skipped || {}).length > 0)) {
                if (confirm('נמצאה התקדמות קודמת. להמשיך מאיפה שעצרת?')) {
                    state = { ...state, ...saved };
                    startQuestionnaire();
                    return;
                }
                clearProgress();
            }
        }

        function startQuestionnaire() {
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('questionnaire').style.display = 'block';
            renderTopicBadges();
            showCurrentQuestion();
        }

        // ============ RENDERING ============
        function renderTopicBadges() {
            const container = document.getElementById('topicBadges');
            container.innerHTML = TOPICS.map((topic, index) => {
                let className = 'topic-badge';
                if (index < state.currentTopicIndex) className += ' completed';
                if (index === state.currentTopicIndex) className += ' active';
                return `<span class="${className}">${topic.icon} ${topic.name}</span>`;
            }).join('');
        }

        function showCurrentQuestion() {
            const topic = TOPICS[state.currentTopicIndex];
            const question = topic.questions[state.currentQuestionIndex];

            // Update UI elements
            document.getElementById('topicTitle').textContent = `${topic.icon} ${topic.name}`;
            document.getElementById('questionNumber').textContent = `שאלה ${state.currentQuestionIndex + 1} מתוך ${topic.questions.length}`;
            document.getElementById('questionText').textContent = question.text;

            // Scaffold
            document.getElementById('scaffoldPoints').innerHTML = 
                question.scaffoldPoints.map(p => `<li>${p}</li>`).join('');
            document.getElementById('exampleText').textContent = question.example;

            // Reset UI
            document.getElementById('answerInput').value = '';
            document.getElementById('charCount').textContent = '0';
            document.getElementById('aiFeedback').className = 'ai-feedback';
            document.getElementById('aiFeedback').style.display = 'none';
            document.getElementById('followupQuestion').style.display = 'none';
            document.getElementById('buttonGroup').style.display = 'flex';
            document.getElementById('continueGroup').style.display = 'none';
            state.waitingForFollowup = false;
            state.currentFollowup = null;

            updateProgress();

            setTimeout(() => document.getElementById('answerInput').focus(), 100);
        }

        function updateProgress() {
            const totalQuestions = TOPICS.reduce((sum, t) => sum + t.questions.length, 0);
            const completed = TOPICS.slice(0, state.currentTopicIndex).reduce((sum, t) => sum + t.questions.length, 0) + state.currentQuestionIndex;
            const percent = Math.round((completed / totalQuestions) * 100);
            
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `הושלמו ${completed} מתוך ${totalQuestions} שאלות`;
        }

        function updateCharCount() {
            const count = document.getElementById('answerInput').value.length;
            document.getElementById('charCount').textContent = count;
        }

        // ============ AI INTEGRATION ============
        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            
            if (!answer) {
                showFeedback('error', '✍️', 'חסרה תשובה', 'נא לכתוב משהו בתיבת הטקסט לפני שממשיכים.');
                return;
            }

            if (answer.length < 15) {
                showFeedback('warning', '📝', 'התשובה קצרה מדי', 'נסי להרחיב קצת - לפחות משפט או שניים. תסתכלי על הדוגמה למעלה.');
                return;
            }

            const topic = TOPICS[state.currentTopicIndex];
            const question = topic.questions[state.currentQuestionIndex];

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('buttonGroup').style.display = 'none';

            try {
                const evaluation = await evaluateAnswer(question, answer, topic.name);
                
                document.getElementById('loading').classList.remove('active');

                if (evaluation.isGibberish) {
                    showFeedback('error', '🤔', 'לא הבנתי את התשובה', 'נראה שהתשובה לא קשורה לשאלה. נסי לענות על מה שנשאל - תסתכלי על הנקודות למעלה.');
                    document.getElementById('buttonGroup').style.display = 'flex';
                    return;
                }

                // Save answer
                if (state.waitingForFollowup && state.currentFollowup) {
                    state.answers[question.id] = (state.answers[question.id] || '') + `\n\n📌 ${state.currentFollowup}\n${answer}`;
                } else {
                    state.answers[question.id] = answer;
                }
                saveProgress();

                if (evaluation.needsFollowup && evaluation.followupQuestion) {
                    showFeedback('success', '👍', evaluation.feedback || 'תודה!', '');
                    document.getElementById('followupQuestion').textContent = '💬 ' + evaluation.followupQuestion;
                    document.getElementById('followupQuestion').style.display = 'block';
                    document.getElementById('continueGroup').style.display = 'flex';
                    state.currentFollowup = evaluation.followupQuestion;
                } else {
                    showFeedback('success', '✅', evaluation.feedback || 'מעולה! התשובה נשמרה.', '');
                    document.getElementById('continueGroup').style.display = 'flex';
                }

            } catch (error) {
                console.error('API Error:', error);
                document.getElementById('loading').classList.remove('active');
                
                // Fallback - save anyway
                state.answers[question.id] = answer;
                saveProgress();
                
                showFeedback('success', '✅', 'התשובה נשמרה!', '');
                document.getElementById('continueGroup').style.display = 'flex';
            }
        }

        async function evaluateAnswer(question, answer, topicName) {
            try {
                const response = await fetch('/api/followup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question.text,
                        answer: answer,
                        topicName: topicName,
                        scaffoldPoints: question.scaffoldPoints,
                        example: question.example
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                return await response.json();
            } catch (error) {
                // Fallback evaluation
                const isGibberish = /^[א-ת]{1,3}$|^test|^asdf|^123/.test(answer.toLowerCase());
                return {
                    isGibberish,
                    needsFollowup: false,
                    feedback: 'תודה!'
                };
            }
        }

        function showFeedback(type, icon, title, text) {
            const el = document.getElementById('aiFeedback');
            el.className = `ai-feedback show ${type}`;
            el.style.display = 'block';
            document.getElementById('feedbackIcon').textContent = icon;
            document.getElementById('feedbackTitle').textContent = title;
            document.getElementById('feedbackText').textContent = text;
        }

        function addMoreDetails() {
            state.waitingForFollowup = true;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').placeholder = 'הוסיפי פרטים נוספים...';
            document.getElementById('answerInput').focus();
            document.getElementById('aiFeedback').style.display = 'none';
            document.getElementById('continueGroup').style.display = 'none';
            document.getElementById('buttonGroup').style.display = 'flex';
        }

        function continueToNext() {
            moveToNextQuestion();
        }

        function moveToNextQuestion() {
            const topic = TOPICS[state.currentTopicIndex];
            
            if (state.currentQuestionIndex < topic.questions.length - 1) {
                state.currentQuestionIndex++;
            } else if (state.currentTopicIndex < TOPICS.length - 1) {
                state.currentTopicIndex++;
                state.currentQuestionIndex = 0;
                renderTopicBadges();
            } else {
                showComplete();
                return;
            }

            saveProgress();
            showCurrentQuestion();
        }

        // ============ SKIP ============
        function showSkipModal() {
            document.getElementById('skipModal').classList.add('active');
        }

        function closeSkipModal() {
            document.getElementById('skipModal').classList.remove('active');
        }

        function skipQuestion(reason) {
            const topic = TOPICS[state.currentTopicIndex];
            const question = topic.questions[state.currentQuestionIndex];
            state.skipped[question.id] = reason;
            saveProgress();
            closeSkipModal();
            moveToNextQuestion();
        }

        // ============ COMPLETE ============
        function showComplete() {
            document.getElementById('questionnaire').style.display = 'none';
            document.getElementById('complete').style.display = 'block';
            document.getElementById('totalAnswers').textContent = Object.keys(state.answers).length;
            clearProgress();
        }

        // ============ EXPORT ============
        async function exportToWord() {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, BorderStyle } = docx;

            const children = [];

            // Title
            children.push(new Paragraph({
                children: [new TextRun({ text: 'שימור ידע - קוראל שירותי ים', bold: true, size: 48 })],
                heading: HeadingLevel.TITLE,
                alignment: AlignmentType.CENTER,
                spacing: { after: 200 }
            }));

            children.push(new Paragraph({
                children: [new TextRun({ text: 'מחלקת אדמיניסטרציה - נטלי מלכה', size: 32 })],
                alignment: AlignmentType.CENTER,
                spacing: { after: 100 }
            }));

            children.push(new Paragraph({
                children: [new TextRun({ text: 'תאריך: ' + new Date().toLocaleDateString('he-IL'), size: 24 })],
                alignment: AlignmentType.CENTER,
                spacing: { after: 400 }
            }));

            // Existing content
            children.push(new Paragraph({
                children: [new TextRun({ text: 'חלק א\' - נושאים קיימים', bold: true, size: 36 })],
                heading: HeadingLevel.HEADING_1,
                spacing: { before: 400, after: 200 }
            }));

            for (const [topicName, content] of Object.entries(EXISTING_CONTENT)) {
                children.push(new Paragraph({
                    children: [new TextRun({ text: topicName, bold: true, size: 28 })],
                    heading: HeadingLevel.HEADING_2,
                    spacing: { before: 300, after: 100 }
                }));

                if (content.process) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: 'תהליך עבודה:', bold: true, size: 24 })],
                        spacing: { before: 100 }
                    }));
                    
                    content.process.split('\n').forEach(line => {
                        if (line.trim()) {
                            children.push(new Paragraph({
                                children: [new TextRun({ text: line.trim(), size: 22 })],
                                spacing: { after: 50 }
                            }));
                        }
                    });
                }

                if (content.supplier) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: 'ספק: ' + content.supplier, size: 22 })],
                        spacing: { before: 100 }
                    }));
                }

                if (content.notes) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: 'הערות: ' + content.notes, size: 22, italics: true })],
                        spacing: { before: 100 }
                    }));
                }
            }

            // New content
            children.push(new Paragraph({
                children: [new TextRun({ text: 'חלק ב\' - נושאים שהושלמו', bold: true, size: 36 })],
                heading: HeadingLevel.HEADING_1,
                spacing: { before: 600, after: 200 }
            }));

            for (const topic of TOPICS) {
                children.push(new Paragraph({
                    children: [new TextRun({ text: topic.icon + ' ' + topic.name, bold: true, size: 28 })],
                    heading: HeadingLevel.HEADING_2,
                    spacing: { before: 300, after: 100 }
                }));

                for (const question of topic.questions) {
                    const answer = state.answers[question.id];
                    const skipped = state.skipped[question.id];

                    children.push(new Paragraph({
                        children: [new TextRun({ text: question.text, bold: true, size: 24 })],
                        spacing: { before: 150 }
                    }));

                    if (answer) {
                        answer.split('\n').forEach(line => {
                            if (line.trim()) {
                                const isFollowup = line.startsWith('📌');
                                children.push(new Paragraph({
                                    children: [new TextRun({ 
                                        text: line.trim(), 
                                        size: 22,
                                        italics: isFollowup
                                    })],
                                    spacing: { after: 50 }
                                }));
                            }
                        });
                    } else if (skipped) {
                        children.push(new Paragraph({
                            children: [new TextRun({ text: '[' + skipped + ']', size: 22, italics: true, color: '888888' })],
                        }));
                    } else {
                        children.push(new Paragraph({
                            children: [new TextRun({ text: '[לא נענה]', size: 22, italics: true, color: '888888' })],
                        }));
                    }
                }
            }

            const doc = new Document({
                sections: [{
                    properties: { bidi: true },
                    children: children
                }]
            });

            try {
                const blob = await Packer.toBlob(doc);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'שימור_ידע_נטלי_מלכה_' + new Date().toISOString().split('T')[0] + '.docx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export error:', error);
                alert('שגיאה בייצוא. נסי שוב או צרי קשר עם אלון.');
            }
        }

        function previewContent() {
            let html = '<div style="direction: rtl; text-align: right;">';
            
            html += '<h4>נושאים קיימים:</h4>';
            for (const [name] of Object.entries(EXISTING_CONTENT)) {
                html += `<p>✓ ${name}</p>`;
            }

            html += '<h4 style="margin-top: 20px;">נושאים חדשים:</h4>';
            for (const topic of TOPICS) {
                html += `<p><strong>${topic.icon} ${topic.name}</strong></p>`;
                for (const q of topic.questions) {
                    const answer = state.answers[q.id];
                    const skipped = state.skipped[q.id];
                    if (answer) {
                        html += `<p style="margin-right: 20px; color: green;">✓ ${q.text.substring(0, 40)}...</p>`;
                    } else if (skipped) {
                        html += `<p style="margin-right: 20px; color: gray;">⊘ ${q.text.substring(0, 40)}... [${skipped}]</p>`;
                    } else {
                        html += `<p style="margin-right: 20px; color: orange;">○ ${q.text.substring(0, 40)}...</p>`;
                    }
                }
            }
            html += '</div>';

            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('previewModal').classList.add('active');
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('active');
        }

        // Init
        window.onload = init;
    </script>
</body>
</html>
